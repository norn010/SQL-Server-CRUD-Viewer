<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Server CRUD Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 text-slate-800">
  <main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <section class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
      <div class="border-b border-slate-200 p-6">
        <h1 class="text-2xl font-bold tracking-tight text-slate-900">SQL Server CRUD Viewer</h1>
        <p class="mt-1 text-sm text-slate-500">View, insert, update, and delete data directly from SQL Server</p>
        <div class="mt-4 rounded-lg bg-slate-50 p-3 text-sm text-slate-700 ring-1 ring-slate-200">
          <span class="font-semibold">Target:</span> {{ connection.target_server }}
          <span class="mx-2 text-slate-400">|</span>
          <span class="font-semibold">Connected:</span> {{ connection.server_name }} ({{ connection.instance_name }})
          <span class="mx-2 text-slate-400">|</span>
          <span class="font-semibold">Database:</span> {{ connection.database_name }}
        </div>

        <form method="get" action="/" class="mt-5 flex flex-wrap items-end gap-3">
          <div>
            <label for="tableKey" class="mb-1 block text-sm font-medium text-slate-700">Select table</label>
            <select
              id="tableKey"
              name="table_key"
              onchange="syncSchemaTable(this.value)"
              class="min-w-64 rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
            >
              <option value="">-- choose table --</option>
              {% for t in tables %}
              {% set key = t.schema + "." + t.name %}
              <option value="{{ key }}" {% if selected_schema == t.schema and selected_table == t.name %}selected{% endif %}>
                {{ key }}
              </option>
              {% endfor %}
            </select>
          </div>
          <input type="hidden" id="schemaInput" name="schema" value="{{ selected_schema or '' }}">
          <input type="hidden" id="tableInput" name="table" value="{{ selected_table or '' }}">
          <input type="hidden" id="pageInput" name="page" value="1">
          <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Load</button>
        </form>
      </div>

      <div class="p-6">
        {% if error_message %}
          <div class="mb-5 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            {{ error_message }}
          </div>
        {% endif %}

        {% if selected_schema and selected_table and columns %}
          <div class="grid gap-6 lg:grid-cols-3">
            <div class="lg:col-span-1">
              <h2 class="text-lg font-semibold text-slate-900">Insert row</h2>
              <p class="mb-3 mt-1 text-sm text-slate-500">{{ selected_schema }}.{{ selected_table }}</p>
              <p class="mb-4 rounded-lg bg-blue-50 px-3 py-2 text-xs text-blue-800 ring-1 ring-blue-100">
                Date: <b>YYYY-MM-DD</b>, Datetime: <b>YYYY-MM-DD HH:MM:SS</b>, Number: ใส่ตัวเลขเท่านั้น
              </p>

              <form method="post" action="/table/{{ selected_schema }}/{{ selected_table }}/insert" class="space-y-3">
                <input type="hidden" name="_page" value="{{ current_page }}">
                {% for c in columns %}
                <div>
                  <label class="mb-1 block text-sm font-medium text-slate-700">{{ c.name }}</label>
                  <input
                    name="{{ c.name }}"
                    placeholder="{{ c.data_type }}{% if c.nullable %} (nullable){% endif %}{% if c.is_identity %} (identity){% endif %}"
                    {% if c.is_identity %}disabled{% endif %}
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm shadow-sm placeholder:text-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 disabled:cursor-not-allowed disabled:bg-slate-100"
                  >
                </div>
                {% endfor %}
                <button type="submit" class="w-full rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700">
                  Insert
                </button>
              </form>
            </div>

            <div class="lg:col-span-2">
              <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
                <h2 class="text-lg font-semibold text-slate-900">Rows</h2>
                <div class="flex flex-col items-end gap-2">
                  <div class="rounded-lg bg-slate-50 px-3 py-2 text-sm text-slate-700 ring-1 ring-slate-200">
                    Showing: <b>{{ row_start }}-{{ row_end }}</b> / Total: <b>{{ total_rows }}</b>
                  </div>
                  <div class="flex flex-wrap items-center justify-end gap-2">
                    <span class="text-sm text-slate-500">Page {{ current_page }} of {{ total_pages }} ({{ page_size }} rows/page)</span>
                    {% if has_prev %}
                      <a
                        href="/?schema={{ selected_schema }}&table={{ selected_table }}&page={{ current_page - 1 }}"
                        class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm text-slate-700 hover:bg-slate-50"
                      >
                        Previous
                      </a>
                    {% endif %}
                    {% if has_next %}
                      <a
                        href="/?schema={{ selected_schema }}&table={{ selected_table }}&page={{ current_page + 1 }}"
                        class="rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700"
                      >
                        Next ({{ row_end + 1 }}+)
                      </a>
                    {% endif %}
                  </div>
                </div>
              </div>

              {% if total_rows == 0 %}
                <div class="mb-3 rounded-lg border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
                  ตารางนี้บนฐานข้อมูลที่กำลังเชื่อมต่ออยู่ยังไม่มีข้อมูล
                </div>
              {% endif %}
              {% if not pk_column %}
                <div class="mb-3 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                  This table has no single-column primary key, so update/delete is disabled.
                </div>
              {% endif %}

              <div class="overflow-x-auto rounded-xl border border-slate-200 bg-white">
                <table class="min-w-full divide-y divide-slate-200">
                  <thead class="bg-slate-50">
                    <tr>
                      {% for c in columns %}
                        <th class="px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-600">{{ c.name }}</th>
                      {% endfor %}
                      <th class="px-3 py-2 text-left text-xs font-semibold uppercase tracking-wide text-slate-600">Action</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-100">
                    {% for row in rows %}
                      <tr class="align-top">
                        <form method="post" action="/table/{{ selected_schema }}/{{ selected_table }}/update/{{ row[pk_column] if pk_column else '' }}">
                          <input type="hidden" name="_page" value="{{ current_page }}">
                          {% for c in columns %}
                            <td class="px-2 py-2">
                              <input
                                name="{{ c.name }}"
                                value="{{ row[c.name] if row[c.name] is not none else '' }}"
                                {% if c.name == pk_column %}readonly{% endif %}
                                class="w-36 rounded-lg border border-slate-300 px-2 py-1.5 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 {% if c.name == pk_column %}bg-slate-100 text-slate-500{% endif %}"
                              >
                            </td>
                          {% endfor %}
                          <td class="px-2 py-2">
                            {% if pk_column %}
                              <div class="flex gap-2">
                                <button type="submit" class="rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-blue-700">
                                  Save
                                </button>
                                <button
                                  type="submit"
                                  formaction="/table/{{ selected_schema }}/{{ selected_table }}/delete/{{ row[pk_column] }}?page={{ current_page }}"
                                  onclick="return confirm('Delete row with {{ pk_column }}={{ row[pk_column] }} ?')"
                                  class="rounded-lg bg-rose-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-rose-700"
                                >
                                  Delete
                                </button>
                              </div>
                            {% endif %}
                          </td>
                        </form>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    function syncSchemaTable(value) {
      const schemaInput = document.getElementById('schemaInput');
      const tableInput = document.getElementById('tableInput');
      if (!value || value.indexOf('.') < 0) {
        schemaInput.value = '';
        tableInput.value = '';
        return;
      }
      const parts = value.split('.');
      schemaInput.value = parts[0];
      tableInput.value = parts.slice(1).join('.');
    }
  </script>
</body>
</html>
